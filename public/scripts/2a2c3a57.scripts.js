"use strict";angular.module("shareupApp",["ngResource"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{token:function(a){return a.get()}}}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).otherwise({redirectTo:"/"})}]).config(["$httpProvider",function(a){var b=["$rootScope","$location","$q",function(a,b,c){var d=function(a){return a},e=function(b){if(401===b.status){var d=c.defer();return a.$broadcast("event:unauthorized"),d.promise}return c.reject(b)};return function(a){return a.then(d,e)}}];a.responseInterceptors.push(b)}]).run(["$rootScope","$http","$location",function(a,b,c){a.$on("event:unauthorized",function(){c.path("/login")})}]),angular.module("shareupApp").controller("MainCtrl",["$scope","$http","ArticleService",function(a,b,c){a.currentUser={},a.articles=c.getLatestFeed()}]),angular.module("shareupApp").controller("LoginCtrl",["$location","$scope","$http","tokenHandler",function(a,b,c,d){b.signup=function(){c({url:"/api/users",method:"POST",data:{user:b.user}}).success(function(c){d.set(c.auth_token),b.$broadcast("event:authenticated"),a.path("/")}).error(function(a){b.user.errors=a})},b.login=function(){c({url:"/api/users/sign_in",method:"POST",data:{user:b.user}}).success(function(c){c.success?(b.ngModel=c.data.data,d.set(c.data.auth_token),a.path("/")):(b.ngModel=c,b.user.errors=c.info)})}}]),angular.module("shareupApp").directive("loginSignup",["$http",function(){return{restrict:"A",templateUrl:"views/login.html",scope:{ngModel:"="},link:function(){}}}]),angular.module("shareupApp").directive("share",["$http","ShareService","tokenHandler",function(a,b,c){return{restrict:"A",require:"ngModel",templateUrl:"views/share.html",link:function(a){a.share=function(d,e){var f=new b({url:e.url,from_user:c.getCurrentUser().id,to_user:d});f.$save(),a.share=f}}}}]),angular.module("shareupApp").directive("isUserOrEmail",["$http","$timeout","$filter","$q","tokenHandler",function(a,b,c,d,e){var f=function(b){var c=d.defer();return a({url:"/api/check/is_user",method:"POST",params:{auth_token:e.get()},data:{name:b}}).then(function(a){200===a.status?c.resolve(a.data):c.reject(a.data)}),c.promise},g=null,h=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}$/;return{restrict:"A",require:"^ngModel",scope:{ngModel:"="},link:function(a,c,d,e){a.$watch(d.ngModel,function(a){g||(g=b(function(){f(a).then(function(b){b.success?e.$setValidity("isUserOrEmail",b.success):e.$setValidity("isUserOrEmail",h.test(a)),g=null})},100))})}}}]),angular.module("shareupApp").factory("tokenHandler",["$rootScope","$http","$q",function(a,b,c){var d,e=null,f={set:function(a){e=a},get:function(){return e?e:(a.$broadcast("event:unauthorized"),void 0)},getCurrentUser:function(){var a=c.defer();return d?a.resolve(d):b({url:"/api/current_user",method:"POST"}).then(function(b){a.resolve(b.data)}),a.promise},wrapActions:function(a,b){for(var c=a,d=0;d<b.length;d++)g(c,b[d]);return c}},g=function(a,b){a["_"+b]=a[b],a[b]=function(c,d,e){return a["_"+b](angular.extend({},c||{},{access_token:f.get()}),d,e)}};return f}]),angular.module("shareupApp").factory("ArticleService",["$http","$q",function(a,b){var c={getLatestFeed:function(){var c=b.defer();return a.jsonp("http://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q="+encodeURIComponent("http://feeds.huffingtonpost.com/huffingtonpost/raw_feed")).then(function(a){200===a.status?c.resolve(a.data.responseData.feed.entries):c.reject(a)}),c.promise}};return c}]),angular.module("shareupApp").factory("ShareService",["$resource","$q","tokenHandler",function(a,b,c){var d=a("/api/shares/:id",{id:"@id"},{});return c.wrapActions(d,["save"]),d}]);