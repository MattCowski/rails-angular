"use strict";angular.module("shareupApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{token:function(a){return a.get()}}}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).otherwise({redirectTo:"/"})}]).config(["$httpProvider",function(a){var b=["$rootScope","$location","$q",function(a,b,c){var d=function(a){return a},e=function(b){if(401===b.status){var d=c.defer();return a.$broadcast("event:unauthorized"),d.promise}return c.reject(b)};return function(a){return a.then(d,e)}}];a.responseInterceptors.push(b)}]).run(["$rootScope","$http","$location",function(a,b,c){a.$on("event:unauthorized",function(){c.path("/login")})}]),angular.module("shareupApp").controller("MainCtrl",["$scope","$http","ArticleService",function(a,b,c){a.currentUser={},c.getLatestFeed().then(function(b){a.articles=b})}]),angular.module("shareupApp").controller("LoginCtrl",["$location","$scope","$http","tokenHandler",function(a,b,c,d){b.signup=function(){c({url:"/api/users",method:"POST",data:{user:b.user}}).success(function(c){d.set(c.auth_token),b.$broadcast("event:authenticated"),a.path("/")}).error(function(a){b.user.errors=a})},b.login=function(){c({url:"/api/users/sign_in",method:"POST",data:{user:b.user}}).success(function(c){c.success?(b.ngModel=c.data.data,d.set(c.data.auth_token),a.path("/")):(b.ngModel=c,b.user.errors=c.info)})}}]),angular.module("shareupApp").factory("tokenHandler",["$rootScope","$http","$q",function(a,b,c){var d,e=null,f={set:function(a){e=a},get:function(){return e?e:(a.$broadcast("event:unauthorized"),void 0)},getCurrentUser:function(){var a=c.defer();return d?a.resolve(d):b({url:"/api/current_user",method:"POST"}).then(function(b){a.resolve(b.data)}),a.promise},wrapActions:function(a,b){for(var c=a,d=0;d<b.length;d++)g(c,b[d]);return c}},g=function(a,b){a["_"+b]=a[b],a[b]=function(c,d,e){return a["_"+b](angular.extend({},c||{},{access_token:f.get()}),d,e)}};return f}]),angular.module("shareupApp").factory("ShareService",["$resource","$q","tokenHandler",function(a,b,c){var d=a("/api/shares/:id",{id:"@id"},{});return c.wrapActions(d,["save"]),d}]),angular.module("shareupApp").factory("ArticleService",["$http","$q",function(a,b){var c={getLatestFeed:function(){var c=b.defer();return a.jsonp("http://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q="+encodeURIComponent("http://feeds.huffingtonpost.com/huffingtonpost/raw_feed")).then(function(a){200===a.status?c.resolve(a.data.responseData.feed.entries):c.reject(a)}),c.promise}};return c}]),angular.module("shareupApp").directive("share",["$http","$timeout","ShareService","tokenHandler",function(a,b,c,d){return{restrict:"A",require:"ngModel",templateUrl:"views/share.html",scope:{ngModel:"=",onShare:"&"},link:function(a){a.newShare={recipient:""},a.showPending=!1,a.showConfirmation=!1,a.share=function(){a.newShare={recipient:""};var e=new c({url:a.ngModel.url,from_user:d.getCurrentUser().id,to_user:a.newShare.recipient});a.showPending=!0,e.$save(function(){a.showPending=!(a.showConfirmation=!0),b(a.hideConfirmation,2e3)})},a.hideConfirmation=function(){a.showConfirmation=!1}}}}]);